
@{
    Layout = null;
}

<style>


</style>
<div class="row">
    <div class="col-md-7 col-sm-7 ">
        <div class="x_panel">
            <div class="x_title">
                <h2>User Profiles <small></small></h2>



                <button type="button" class="btn btn-primary pull-right"
                        onclick="javascript:UpdateContenedor('Usuarios/NewPerfil');">
                    <span class="glyphicon glyphicon-plus" id="icon_enabled"
                          style="color:white;"></span> NEW
                </button>

                <button id="seeAll" style="" class="btn btn-warning pull-right" type="button">
                    <span id="icono"
                          class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> SEE ALL
                </button>


                <div class="clearfix"></div>
                <!--You can add col-lg-12 if you want -->

            </div>
            <div class="x_content">
                <br>
                <table id="TableContent" class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Profile Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="Xtabla">

                        <tr>
                            <th scope="row">2</th>
                            <td><button type="button" class="btn btn-link">TMO</button></td>
                            <td>
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Actions
                                </button><div class="dropdown-menu">
                                    <a class="dropdown-item" href="#">Edit</a>
                                    <a class="dropdown-item" href="#">Delete</a>
                                </div>
                            </td>
                        </tr>

                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-5 col-sm-5 ">
        <div class="x_panel">
            <div class="x_title">
                <h2>Details<small></small></h2>

                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <div id="ContenidoPerfil">


                </div>
                <br>
                <h2 style=" color: black; font-weight: bold;">Profile Information</h2>
                <ul>
                    <li id="idPerfil">ID: --</li>
                    <li id="PerfilName">PERFIL: --</li>
                    <ul>
                        <h4 style=" color: black; font-weight: bold;">Modules</h4>
                        <ul id="ModulosPerfil">--</ul>

                    </ul>
                    <ul>
                        <h4 style=" color: black; font-weight: bold;">Systems</h4>
                        <ul id="SistemasPerfil">--</ul>

                    </ul>
                    <ul>
                        <h4 style=" color: black; font-weight: bold;">Buildings</h4>
                        <ul id="EdificiosPerfil">--</ul>

                    </ul>
                </ul>
            </div>
        </div>
    </div>
</div>



<script type="text/javascript">

    var Perfiles;
    var ocultarelementos = 0;
    FillPerfiles("0");
    function FillPerfiles(All) {
        var parametros = {
            "All": All
        };
        $("#Xtabla").empty();
       // $('#TableContent').DataTable().clear();
        var sURL = IPWS + "getAllPerfiles";
        $.ajax({
            url: sURL,
            dataType: "json",
            type: "GET",
            async: false,
            data: parametros,
            headers: {
                Authorization: 'Bearer ' + Token
            },
            success: function (data) {
                if (data[0].PerfilName != null) {
                    Perfiles = data;
                    for (var i = 0; i < Perfiles.length; i++) {
                        var TxtBtnDelete = "";
                        if (Perfiles[i].Status == "true") {
                            TxtBtnDelete = "Disabled"
                        } else {
                            TxtBtnDelete = "Enabled";
                        }
                        $("#Xtabla").append('<tr> <th scope="row">' + Perfiles[i].ID + '</th> <td><button type="button" class="btn btn-link" onclick="llenarTree(' + i + ')">' + Perfiles[i].PerfilName + '</button></td><td> <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> Actions </button><div class="dropdown-menu"> <a class="dropdown-item" onclick="enviarEditarPerfil(' + Perfiles[i].ID + ')">Edit</a> <a class="dropdown-item" onclick="DeletePerfil(' + Perfiles[i].ID + ',' + Perfiles[i].Status + ');" ">'+ TxtBtnDelete +'</a> </div></td></tr>');
                    }
                }

            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {

            }
        });
       //$('#TableContent').DataTable().column('1:visible').draw();
        //$('#TableContent').DataTable().order([0, 'desc']).draw();


    }
    function enviarEditarPerfil( id) {
        console.log(id)
        UpdateContenedor('Usuarios/EditarPerfil?id='+id);
    }
    function llenarTree(pos) {
        console.log(pos);
        if (pos != null || pos != undefined) {
            $('#ContenidoPerfil').show();
            $('#idPerfil').html("ID: " + Perfiles[pos].ID);
            $('#PerfilName').html("PERFIL NAME: " + Perfiles[pos].PerfilName);
            //modulos
            $("#ModulosPerfil").empty();
            for (var i = 0; i < Perfiles[pos].ListPerfil_Modulos.length; i++) {
                var Nivel = "";
                if (Perfiles[pos].ListPerfil_Modulos[i].Nivel == 1) {
                    Nivel = '<span class="badge  badge-success ">ADMINISTRATOR</span>';
                }
                if (Perfiles[pos].ListPerfil_Modulos[i].Nivel == 2) {
                    Nivel = '<span class="badge badge-danger ">SUPERVISOR</span>';
                }
                if (Perfiles[pos].ListPerfil_Modulos[i].Nivel >= 3) {
                    Nivel = '<span class="badge badge-warning ">OPERATOR</span>';
                }
                $("#ModulosPerfil").append(' <li>' + Perfiles[pos].ListPerfil_Modulos[i].ModuloName + ' - '+ Nivel +'</li>');
            }
            //sistemas
            $("#SistemasPerfil").empty(); 
             for (var i = 0; i < Perfiles[pos].ListPerfil_Sistemas.length; i++) {
                $("#SistemasPerfil").append(' <li>' + Perfiles[pos].ListPerfil_Sistemas[i].SistemaName + '</li>');
            }
            //Edificios
            $("#EdificiosPerfil").empty();
            for (var i = 0; i < Perfiles[pos].ListPerfil_Edificios.length; i++) {
                $("#EdificiosPerfil").append(' <li>' + Perfiles[pos].ListPerfil_Edificios[i].EdificioName + '</li>');
            }

        }
    }




    function DeletePerfil(ID, Status) {
      
        var cambioStatus;
        var ID = ID;
        var TextoStatus;
        if (Status == true) {
            cambioStatus = "false";
            TextoStatus = "DISABLED";
        } else {
            cambioStatus = "true";
            TextoStatus = "ENABLED";
        }
        var para = {
            "ID": ID,
            "Status": cambioStatus,
        };
        Swal.fire({
            title: "ARE YOU SURE",
            text: "YOU WANT TO " + TextoStatus + " THIS PROFILE?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: "YES!, " + TextoStatus + ""
        }).then((result) => {
            if (result.isConfirmed) {
                var sURL = IPWS + "DeletePerfil";
                $.ajax({
                    url: sURL,
                    dataType: "json",
                    type: "POST",
                    async: false,
                    data: para,
                    headers: {
                        Authorization: 'Bearer ' + Token
                    },
                    success: function (data) {
                        if (data.Status == "OK") {
                            Swal.fire(
                                'OK!',
                                "THE PROFILE " + TextoStatus + "  SUCCESSFULLY!",
                                'success'
                            )
                            $('#TableContent').DataTable().clear().draw();
                            FillPerfiles("0");
                            ocultarelementos = 0;
                        } else {
                            Swal.fire("Error ", "ERROR " + TextoStatus + "  PROFILE USER", "error");
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                    }
                });
            } else {
                Swal.fire("WITHOUT CHANGES!");
            }
        });
    }


  
    $('#seeAll').click(function () {
        if (ocultarelementos == 0) {
            $("#icono").removeClass("glyphicon glyphicon-eye-open");
            $("#icono").addClass("glyphicon glyphicon-eye-close");
            FillPerfiles("1");
            ocultarelementos = 1;
        } else {
            $("#icono").removeClass("glyphicon glyphicon-eye-close");
            $("#icono").addClass("glyphicon glyphicon-eye-open");
            FillPerfiles("0");
            ocultarelementos = 0;
        }
    });

</script>